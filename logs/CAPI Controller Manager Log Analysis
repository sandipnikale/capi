CAPI Controller Manager Log Analysis - cluster1This document provides a breakdown of the key events observed in the Cluster API (CAPI) controller manager logs during the provisioning and scaling of the capi-clusters/cluster1.Phase 1: CAPI Controller Manager InitializationThis phase covers the startup of the CAPI controller manager pod, its initialization processes, and the start of its various controllers.Log Snippets:I0506 18:27:39.096999       1 webhook.go:163] "Registering a mutating webhook" logger="controller-runtime.builder" GVK="cluster.x-k8s.io/v1beta1, Kind=ClusterClass" path="/mutate-cluster-x-k8s-io-v1beta1-clusterclass"
I0506 18:27:39.097094       1 server.go:183] "Registering webhook" logger="controller-runtime.webhook" path="/mutate-cluster-x-k8s-io-v1beta1-clusterclass"
... (many similar lines for other CAPI resource types) ...
I0506 18:27:39.099643       1 webhook.go:202] "Registering a validating webhook" logger="controller-runtime.builder" GVK="ipam.cluster.x-k8s.io/v1beta1, Kind=IPAddressClaim" path="/validate-ipam-cluster-x-k8s-io-v1beta1-ipaddressclaim"
These logs indicate the controller manager is registering webhooks for various Cluster API custom resources. These webhooks are used to intercept API requests for these resources to perform validation and mutation.I0506 18:27:39.099691       1 main.go:398] "Starting manager" logger="setup" version=""
The main controller process starts.I0506 18:27:39.200982       1 leaderelection.go:254] attempting to acquire leader lease capi-system/controller-leader-election-capi...
The controller initiates the leader election process to ensure high availability and prevent multiple instances from conflicting.I0506 18:28:06.535622       1 leaderelection.go:268] successfully acquired lease capi-system/controller-leader-election-capi
This specific controller instance has won the leader election and will now be the active controller.I0506 18:28:06.536237       1 controller.go:175] "Starting EventSource" controller="clustercache" controllerGroup="cluster.x-k8s.io" controllerKind="Cluster" source="kind source: *v1beta1.Cluster"
... (many similar lines for other controllers) ...
I0506 18:28:06.542332       1 controller.go:183] "Starting Controller" controller="machinepool" controllerGroup="cluster.x-k8s.io" controllerKind="MachinePool"
Individual controllers within the manager are starting up and setting up watches on relevant Kubernetes resources (like Cluster, Machine, MachineSet, etc.) to react to changes.Phase 2: Cluster Provisioning BeginsCAPI detects the newly created Cluster object and starts the provisioning process.Log Snippets:I0506 18:30:08.135114       1 tracker.go:58] "Adding watch on external object \"infrastructure.cluster.x-k8s.io/v1beta1, Kind=DockerCluster\"" controller="cluster" controllerGroup="cluster.x-k8s.io" controllerKind="Cluster" Cluster="capi-clusters/cluster1" namespace="capi-clusters" name="cluster1" reconcileID="7d7b05f0-b0a3-4199-be70-38674e7db1c1"
I0506 18:30:08.250040       1 tracker.go:58] "Adding watch on external object \"controlplane.cluster.x-k8s.io/v1beta1, Kind=RKE2ControlPlane\"" controller="cluster" controllerGroup="cluster.x-k8s.io" controllerKind="Cluster" Cluster="capi-clusters/cluster1" namespace="capi-clusters" name="cluster1" reconcileID="7d7b05f0-b0a3-4199-be70-38674e7db1c1"
The cluster controller starts watching the associated infrastructure (DockerCluster) and control plane (RKE2ControlPlane) provider-specific resources.I0506 18:30:08.264727       1 recorder.go:104] "Cluster cluster1 is Provisioning" logger="events" type="Normal" object={"kind":"Cluster","namespace":"capi-clusters","name":"cluster1","uid":"4de421ae-f2d1-4490-a693-7eae4f9d965c","apiVersion":"cluster.x-k8s.io/v1beta1","resourceVersion":"8247"} reason="Provisioning"
The Cluster object's status is updated to Provisioning.I0506 18:30:08.324485       1 machinedeployment_sync.go:183] "MachineSet created (no MachineSets exist for the MachineDeployment)" controller="machinedeployment" controllerGroup="cluster.x-k8s.io" controllerKind="MachineDeployment" MachineDeployment="capi-clusters/cluster1-md-0" namespace="capi-clusters" name="cluster1-md-0" reconcileID="529e5934-4b7d-4e03-bcb0-4454f4b3f7cb" Cluster="capi-clusters/cluster1" MachineSet="capi-clusters/cluster1-md-0-xgfq4"
A MachineSet (cluster1-md-0-xgfq4) is created as part of the worker MachineDeployment (cluster1-md-0).I0506 18:30:08.388010       1 machineset_preflight.go:139] "Scale up on hold because RKE2ControlPlane capi-clusters/cluster1-control-plane is provisioning (\"ControlPlaneIsStable\" preflight check failed). The operation will continue after the preflight check(s) pass" ...
The MachineSet controller attempts to scale up but is put on hold because the control plane is not yet stable. This is a crucial preflight check.Phase 3: Control Plane Provisioning & ReadinessCAPI coordinates with the infrastructure and control plane providers to bring up the control plane node.Log Snippets:I0506 18:30:20.651319       1 machine_controller_phases.go:205] "Waiting for bootstrap provider to generate data secret and report status.ready" ... Machine="capi-clusters/cluster1-control-plane-4tsmr" ...
I0506 18:30:20.759898       1 machine_controller_phases.go:281] "Waiting for infrastructure provider to create machine infrastructure and report status.ready" ... Machine="capi-clusters/cluster1-control-plane-4tsmr" ...
The machine controller for the control plane node waits for the bootstrap provider (RKE2Config) to generate necessary data and for the infrastructure provider (DockerMachine) to create the underlying machine. These messages repeat until the conditions are met.I0506 18:32:33.949225       1 cluster_accessor.go:252] "Connecting" controller="clustercache" ... Cluster="capi-clusters/cluster1" ...
I0506 18:32:34.061585       1 cluster_accessor.go:271] "Connected" controller="clustercache" ... Cluster="capi-clusters/cluster1" ...
CAPI successfully establishes a connection to the workload cluster's API server, indicating the control plane is becoming available.I0506 18:32:34.853778       1 machine_controller_phases.go:262] "Infrastructure provider has completed machine infrastructure provisioning and reports status.ready" ... Machine="capi-clusters/cluster1-control-plane-4tsmr" ...
I0506 18:32:34.853968       1 machine_controller_noderef.go:108] "Infrastructure provider reporting spec.providerID, Kubernetes node is now available" ... Machine="capi-clusters/cluster1-control-plane-4tsmr" ... Node="cluster1-control-plane-4tsmr"
The infrastructure provider confirms the control plane machine is ready, and CAPI successfully associates it with a Kubernetes Node object in the workload cluster.I0506 18:32:35.231244       1 cluster_controller_phases.go:291] "ControlPlane provider has completed provisioning and reports status.ready" ... RKE2ControlPlane="capi-clusters/cluster1-control-plane"
I0506 18:32:35.231846       1 recorder.go:104] "Cluster cluster1 ControlPlaneReady is now True" ...
The control plane provider reports readiness, and the Cluster object's status is updated to reflect this.Phase 4: Worker Node Provisioning (Initial)Once the control plane is ready, the worker MachineSet can proceed with creating worker nodes.Log Snippets:I0506 18:32:38.572523       1 machineset_controller.go:685] "MachineSet is scaling up to 1 replicas by creating 1 machines" ... MachineSet="capi-clusters/cluster1-md-0-xgfq4" ... replicas=1 machineCount=0
The MachineSet controller starts the scale-up process now that the control plane is stable.I0506 18:32:38.613232       1 machineset_controller.go:799] "Machine created (scale up, creating 1 of 1)" ... MachineSet="capi-clusters/cluster1-md-0-xgfq4" ... Machine="capi-clusters/cluster1-md-0-xgfq4-spgql"
CAPI creates the Machine object for the first worker node.I0506 18:33:14.931036       1 machine_controller_phases.go:262] "Infrastructure provider has completed machine infrastructure provisioning and reports status.ready" ... Machine="capi-clusters/cluster1-md-0-xgfq4-spgql" ...
I0506 18:33:14.931164       1 machine_controller_noderef.go:108] "Infrastructure provider reporting spec.providerID, Kubernetes node is now available" ... Machine="capi-clusters/cluster1-md-0-xgfq4-spgql" ... Node="cluster1-md-0-xgfq4-spgql"
The infrastructure provider reports the worker machine is ready, and CAPI registers the corresponding Kubernetes Node.I0506 18:33:33.822650       1 machineset_controller.go:1242] "All the replicas are ready" ... MachineSet="capi-clusters/cluster1-md-0-xgfq4" ... replicas=1
The MachineSet has successfully scaled to its desired initial replica count (1).Phase 5: Scaling Up Worker NodesThis phase shows the logs when the worker MachineDeployment is scaled up from 1 to 4 replicas.Log Snippets:I0506 18:46:06.654019       1 recorder.go:104] "Scaled MachineSet capi-clusters/cluster1-md-0-xgfq4: 1 -> 4" ...
An event is recorded indicating the MachineSet is being scaled from 1 to 4 replicas.I0506 18:46:06.832926       1 machineset_controller.go:685] "MachineSet is scaling up to 4 replicas by creating 3 machines" ... MachineSet="capi-clusters/cluster1-md-0-xgfq4" ... replicas=4 machineCount=1
The MachineSet controller begins the process of creating 3 new machines to reach the desired count of 4.I0506 18:46:07.010324       1 machineset_controller.go:799] "Machine created (scale up, creating 1 of 3)" ... Machine="capi-clusters/cluster1-md-0-xgfq4-zmqng"
I0506 18:46:07.252141       1 machineset_controller.go:799] "Machine created (scale up, creating 2 of 3)" ... Machine="capi-clusters/cluster1-md-0-xgfq4-2lwdm"
I0506 18:46:07.469813       1 machineset_controller.go:799] "Machine created (scale up, creating 3 of 3)" ... Machine="capi-clusters/cluster1-md-0-xgfq4-6rr7g"
CAPI creates the Machine objects for the three new worker nodes.I0506 18:46:47.354651       1 machine_controller_phases.go:262] "Infrastructure provider has completed machine infrastructure provisioning and reports status.ready" ... Machine="capi-clusters/cluster1-md-0-xgfq4-zmqng" ...
I0506 18:46:52.200711       1 machine_controller_phases.go:262] "Infrastructure provider has completed machine infrastructure provisioning and reports status.ready" ... Machine="capi-clusters/cluster1-md-0-xgfq4-6rr7g" ...
I0506 18:46:53.220926       1 machine_controller_phases.go:262] "Infrastructure provider has completed machine infrastructure provisioning and reports status.ready" ... Machine="capi-clusters/cluster1-md-0-xgfq4-2lwdm" ...
Logs confirm that the infrastructure provider has finished provisioning the new machines.I0506 18:47:38.774550       1 machineset_controller.go:1242] "All the replicas are ready" ... MachineSet="capi-clusters/cluster1-md-0-xgfq4" ... replicas=4
The MachineSet successfully reached the desired state of 4 ready replicas.Phase 6: Scaling Down Worker NodesThis phase shows the logs when the worker MachineDeployment is scaled down from 4 to 1 replica.Log Snippets:I0506 18:47:56.913047       1 recorder.go:104] "Scaled MachineSet capi-clusters/cluster1-md-0-xgfq4: 4 -> 1" ...
An event is recorded indicating the MachineSet is being scaled down from 4 to 1 replica.I0506 18:47:57.177814       1 machineset_controller.go:809] "MachineSet is scaling down to 1 replicas by deleting 3 machines" ... MachineSet="capi-clusters/cluster1-md-0-xgfq4" ... replicas=1 machineCount=4 deletePolicy="Random"
The MachineSet controller starts the process of deleting 3 machines.I0506 18:47:57.238019       1 machineset_controller.go:829] "Deleting Machine (scale down, deleting 1 of 3)" ... Machine="capi-clusters/cluster1-md-0-xgfq4-2lwdm"
I0506 18:47:57.375706       1 machineset_controller.go:829] "Deleting Machine (scale down, deleting 2 of 3)" ... Machine="capi-clusters/cluster1-md-0-xgfq4-6rr7g"
I0506 18:47:57.522108       1 machineset_controller.go:829] "Deleting Machine (scale down, deleting 3 of 3)" ... Machine="capi-clusters/cluster1-md-0-xgfq4-spgql"
CAPI marks the Machine objects for deletion.I0506 18:47:57.574277       1 drain.go:73] "Cordoning Node" ... Machine="capi-clusters/cluster1-md-0-xgfq4-2lwdm" ... Node="cluster1-md-0-xgfq4-2lwdm"
I0506 18:47:57.898488       1 machine_controller.go:890] "Draining Node" ... Machine="capi-clusters/cluster1-md-0-xgfq4-2lwdm" ... Node="cluster1-md-0-xgfq4-2lwdm"
I0506 18:47:57.898551       1 drain.go:308] "Drain not completed yet, there are still Pods on the Node that have to be drained" ...
CAPI cordons and starts draining the corresponding Kubernetes nodes to safely remove workloads before deleting the machines. The "Drain not completed yet" message indicates ongoing pod termination/migration.I0506 18:48:18.043453       1 machine_controller.go:886] "Drain completed" ... Machine="capi-clusters/cluster1-md-0-xgfq4-2lwdm" ...
I0506 18:48:18.153210       1 machine_controller.go:592] "Waiting for infrastructure to be deleted" ... Machine="capi-clusters/cluster1-md-0-xgfq4-2lwdm" ...
I0506 18:48:31.942543       1 machine_controller.go:606] "Waiting for bootstrap to be deleted" ... Machine="capi-clusters/cluster1-md-0-xgfq4-2lwdm" ...
I0506 18:48:32.757480       1 machine_controller.go:616] "Deleting node" ... Machine="capi-clusters/cluster1-md-0-xgfq4-2lwdm" ... Node="cluster1-md-0-xgfq4-2lwdm"
These logs show the successful completion of the drain, waiting for the underlying infrastructure and bootstrap resources to be deleted by their respective providers, and finally deleting the Kubernetes Node object. These steps are repeated for each machine being scaled down.E0506 18:48:42.425756       1 controller.go:316] "Reconciler error" err="failed to sync Machines: failed to patch Machine capi-clusters/cluster1-md-0-xgfq4-6rr7g: machines.cluster.x-k8s.io \"cluster1-md-0-xgfq4-6rr7g\" not found" ...
This error indicates a transient issue where CAPI attempted to interact with a Machine object that had already been removed by the underlying provider. This is often expected during concurrent deletion processes and is usually resolved by subsequent reconciliations.I0506 18:48:42.427746       1 machineset_controller.go:1242] "All the replicas are ready" ... MachineSet="capi-clusters/cluster1-md-0-xgfq4" ... replicas=1
Despite the transient errors, the MachineSet eventually reaches the desired state of 1 ready replica.When to Check These LogsYou should check the CAPI controller manager logs whenever you encounter issues related to the lifecycle of your CAPI-managed clusters and machines. This includes:Cluster creation failures or delays: If the cluster status is stuck in Provisioning or doesn't become Ready.Machine provisioning issues: If control plane or worker machines fail to boot, join the cluster, or reach a ready state.Scaling problems: If MachineDeployments fail to scale up or down correctly, or if machines get stuck during creation or deletion.Node drain or cordon failures: If nodes are not draining properly during scale-down or upgrades.Cluster deletion issues: If a cluster fails to delete completely.Connectivity problems: Errors indicating the CAPI controller cannot connect to the workload cluster.Unexpected resource states: If CAPI resources (like Machines or MachineSets) are in unexpected phases or have error conditions.Examining these logs helps pinpoint which part of the cluster lifecycle is failing and often provides clues about whether the issue lies within CAPI itself, the bootstrap provider, or the infrastructure provider.
